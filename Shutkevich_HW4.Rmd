---
title: "Untitled"
output: html_document
date: "2024-04-02"
---

# Домашнее задание 4

## Использование основных статистических тестов и поправок на множественные сравнения.

# Задание 1

Проводят некоторое исследование пациентов с артериальной гипертензией. Предположим, что внедрение нового препарата в среднем лучше снижает их давление по сравнению со стандартной терапией. Задайте seed для воспроизводимости результатом (функция set.seed()). Задайте размер выборки sample_size \<- 30. Задайте значение среднего артериального давления до приема нового препарата и после. Сформулируйте нулевую и альтернативную гипотезы. Определите уровень значимости. Выберите статистический тест для проверки гипотезы и аргументируйте свой выбор. Определите наблюдаемое значение статистики, а также критическое значение статистики. Оцените и прокомментируйте статистическую значимость.

```{r task 1, include=TRUE}
# Установка seed для воспроизводимости результатов.set.seed(123) гарантирует, что результаты будут воспроизводимыми, если код будет запущен повторно
set.seed(123)

# Размер выборки <- 30 задает размер выборки в 30 пациентов
sample_size <- 30

# Генерация данных. rnorm генерирует нормально распределенные данные артериального давления, измеренные "до лечения" и "после лечения".
before_treatment <- rnorm(sample_size, mean = 140, sd = 10)
after_treatment <- rnorm(sample_size, mean = 130, sd = 10)

# Нулевая гипотеза H0: среднее давление до и после приема препарата не изменилось
# Альтернативная гипотеза H1: среднее давление после приема препарата снизилось

# Уровень значимости alpha устанавливается на 0.05, что является стандартным порогом для многих статистических тестов
alpha <- 0.05

# Выбор статистического теста: t-тест для зависимых выборок. t.test с параметром paired = TRUE указывает на то, что мы проводим парный t-тест, так как данные до и после лечения связаны между собой.
# alternative = "greater" указывает, что мы тестируем одностороннюю альтернативную гипотезу о том, что среднее давление после лечения меньше, чем до лечения.

t_test_result <- t.test(before_treatment, after_treatment, paired = TRUE, alternative = "greater")

# Вывод результатов теста
t_test_result

```

Полученное нами значение t-статистики равно 3.0634. Это значение показывает, насколько далеко наше наблюдаемое среднее различие отклоняется от нуля (или от предполагаемого значения нулевой гипотезы) в единицах стандартной ошибки.

Степени свободы (df): Степени свободы для этого теста равны 29. Это число получается из размера выборки (30) минус 1.

Полученное нами P-значение равно 0.002346. Это вероятность получить такое же или более экстремальное значение t-статистики, если бы нулевая гипотеза была верна. В данном случае, p-значение намного меньше установленного уровня значимости (обычно 0.05), что позволяет нам отвергнуть нулевую гипотезу и принять альтернативную гипотезу о том, что новый препарат в среднем лучше снижает давление по сравнению со стандартной терапией.

Наша альтернативная гипотеза предполагает, что среднее значение разницы давления (после - до) больше нуля (true mean difference is greater than 0), что соответствует нашему ожиданию, что новый препарат снижает давление.

95% доверительный интервал для среднего различия между давлением до и после лечения составил от 3.449492 до бесконечности. Это означает, что мы на 95% уверены, что среднее снижение давления находится в этом интервале. Тот факт, что интервал не включает ноль, подтверждает статистическую значимость результатов.

Среднее различие между давлением до и после приема препарата составляет 7.745579 мм рт. ст. Это означает, что в среднем новый препарат снижает давление на 7.745579 мм рт. ст. по сравнению со стандартной терапией.

Таким образом, результаты парного t-теста показывают, что есть статистически значимое снижение артериального давления после введения нового препарата по сравнению со стандартной терапией.

# Задание 2

Существует некоторая связь между курением и развитием рака легких. Пусть у курящих людей вероятность заболеть раком легких составляет 0.8, а у некурящих – 0.2 Рассмотрите два случая: для выборки sample_size1 \<- 100 и sample_size2 \<- 30. Сгенерируйте данные по курению с помощью функции rep(), пусть отношение числа курящих к некурящим в каждой выборке составляет 1:1. Сформулируйте нулевую и альтернативную гипотезы. Определите уровень значимости. Выберите статистический тест для проверки гипотезы и аргументируйте свой выбор. Определите наблюдаемое значение статистики, а также критическое значение статистики. Оцените и прокомментируйте статистическую значимость. (3 балла)

```{r task 2, include=TRUE}
# Установка seed для для воспроизводимости результатов.set.seed(123) гарантирует, что результаты будут воспроизводимыми, если код будет запущен повторно
set.seed(123)

# Размеры выборок
sample_size1 <- 100
sample_size2 <- 30

# Генерация данных. Мы создаем две выборки данных для курящих и некурящих людей, используя функцию rep(), которая повторяет значения в векторе. Затем мы генерируем случаи рака легких с помощью функции rbinom(), которая генерирует случайные значения из биномиального распределения, где вероятность заболевания раком легких у курящих составляет 0.8, а у некурящих – 0.2

smokers1 <- rep(c(1, 0), each = sample_size1 / 2)
lung_cancer1 <- c(rbinom(sample_size1 / 2, 1, 0.8), rbinom(sample_size1 / 2, 1, 0.2))

smokers2 <- rep(c(1, 0), each = sample_size2 / 2)
lung_cancer2 <- c(rbinom(sample_size2 / 2, 1, 0.8), rbinom(sample_size2 / 2, 1, 0.2))

# Формулировка гипотез
# Нулевая гипотеза (H0): Нет связи между курением и раком легких. Это означает, что вероятность развития рака легких у курящих и некурящих одинакова.
# Альтернативная гипотеза (H1): Существует связь между курением и раком легких. Вероятность заболеть раком легких у курящих выше, чем у некурящих.

# Уровень значимости alpha обычно устанавливается на уровне 0.05, что означает, что мы готовы принять вероятность ошибочного отклонения нулевой гипотезы в 5% случаев
alpha <- 0.05

# Выбор статистического теста: хи-квадрат тест независимости
# Этот тест используется для категориальных данных, чтобы проверить, есть ли статистически значимая связь между двумя переменными. Используем функцию chisq.test() для выполнения хи-квадрат теста на двух разных выборках (с размерами 100 и 30). Функция принимает на вход таблицу сопряженности, созданную с помощью table(), которая содержит частоты встречаемости каждой комбинации категорий (курение и рак легких).

# Для выборки sample_size1
chi_test_result1 <- chisq.test(table(smokers1, lung_cancer1))

# Для выборки sample_size2
chi_test_result2 <- chisq.test(table(smokers2, lung_cancer2))

# Вывод результатов теста
chi_test_result1
chi_test_result2

```

Для выборки размером 100 (sample_size1) получили следующие результаты теста: X-squared = 38.688, количество степеней свободы df = 1. В хи-квадрат тесте количество степеней свободы обычно равно (количество строк - 1) \* (количество столбцов - 1). В данном случае у нас есть две категории для каждой переменной (курение и рак легких), поэтому df = (2 - 1) \* (2 - 1) = 1. p-value = 4.974e-10: p-значение теста очень маленькое и на порядки меньше уровня значимости 0.05. Таким образом, поскольку P-значение гораздо меньше уровня значимости (α = 0.05), мы отвергаем нулевую гипотезу о том, что нет связи между курением и раком легких. Статистически значимый результат теста позволяет нам заключить, что существует связь между курением и развитием рака легких в этой выборке.

Для выборки размером 30 (sample_size2) получили следующие результаты теста: X-squared = 6.8056, количество степеней свободы df также равно 1, как и в предыдущем случае. p-значение теста составляет 0.009087, что также меньше уровня значимости 0.05. И поскольку P-значение меньше уровня значимости (α = 0.05), следовательно, мы также отвергаем нулевую гипотезу для этой выборки. Это означает, что и в этом случае мы также находим статистически значимую связь между курением и раком легких.

Несмотря на то, что обе выборки показали статистически значимые результаты, мы должны помнить, что размер выборки влияет на мощность теста. Большая выборка (sample_size1) имеет большую мощность для обнаружения реальной связи, чем меньшая выборка (sample_size2).

```{r task 2 visualization of samples, include=TRUE}
library(ggplot2)

# Создание датафреймов для обеих выборок
data1 <- data.frame(Sample = "выборка на 100 человек",
                    SmokingStatus = factor(smokers1, labels = c("Non-smoker", "Smoker")),
                    LungCancer = as.factor(lung_cancer1))

data2 <- data.frame(Sample = "выборка на 30 человек",
                    SmokingStatus = factor(smokers2, labels = c("Non-smoker", "Smoker")),
                    LungCancer = as.factor(lung_cancer2))

# Объединение датафреймов
combined_data <- rbind(data1, data2)

# Визуализация данных для обеих выборок
ggplot(combined_data, aes(x = SmokingStatus, fill = LungCancer)) +
  geom_bar(position = "dodge") +
  facet_wrap(~ Sample, scales = "free_y") +
  scale_fill_manual(values = c("gray", "red"), labels = c("No Lung Cancer", "Lung Cancer")) +
  labs(x = "Статус курит/не курит", y = "Количество людей", fill = "Заболевание") +
  theme_minimal()

```

# Задание 3

Применение нового метода лечения синдрома раздраженного кишечника значимо меняет уровень болевых симптомов по сравнению с группой, прошедшей лечение диетотерапией. (исследователь избегает любых допущений, кроме того, что выборки независимы и имеют одинаковое распределение) Сформулируйте нулевую и альтернативную гипотезы. Определите уровень значимости. Выберите статистический тест для проверки гипотезы и аргументируйте свой выбор. Определите наблюдаемое значение статистики, а также критическое значение статистики. Оцените и прокомментируйте статистическую значимость. (3 балла)

```{r task 3, include=TRUE}
# Установка seed для для воспроизводимости результатов.set.seed(123) гарантирует, что результаты будут воспроизводимыми, если код будет запущен повторно
set.seed(123)

# Генерируем данные для двух групп. Пусть в каждой будет по 50 пациентов.
group1 <- runif(50, min=0, max=10)  # Диетотерапия
group2 <- runif(50, min=0, max=10)  # Новый метод лечения

#Формулировка гипотез
#Нулевая гипотеза (H0): Новый метод лечения не оказывает влияния на уровень болевых симптомов по сравнению с диетотерапией. Это означает, что различия в уровне болевых симптомов между группами не являются статистически значимыми.
#Альтернативная гипотеза (H1): Новый метод лечения оказывает влияние на уровень болевых симптомов по сравнению с диетотерапией. То есть, существуют статистически значимые различия в уровне болевых симптомов между группами.

# Уровень значимости. Обычно выбирают α = 0.05, что означает, что мы готовы принять до 5% вероятности ошибочно отвергнуть нулевую гипотезу, когда она на самом деле верна
alpha <- 0.05

#Для проверки гипотезы мы должны выбрать подходящий статистический тест. В данном случае, исследователь избегает предположений о распределении данных, что делает неприменимыми параметрические тесты, такие как t-тест, которые требуют нормальности распределения данных. Вместо этого мы используем непараметрический тест Манна-Уитни (также известный как U-тест), который не делает предположений о форме распределения данных и может использоваться для сравнения двух независимых выборок. Этот тест сравнивает медианы двух групп и является альтернативой t-теста для независимых выборок в случае, если данные не соответствуют предположениям параметрических тестов.

test_result <- wilcox.test(group1, group2)

# Наблюдаемое значение статистики и p-value
test_statistic <- test_result$statistic
p_value <- test_result$p.value

# Выводим результаты
test_statistic
p_value

# Оценка значимости
if (p_value < alpha) {
  print("Отвергаем нулевую гипотезу, есть значимые различия.")
} else {
  print("Не отвергаем нулевую гипотезу, нет значимых различий.")
}

```

Мы получили результаты теста Манна-Уитни для сравнения двух независимых выборок размером по 50 каждая.

Значение статистики теста (W) 1366 показывает, насколько сильно ранги (порядок) значений в одной выборке отличаются от рангов в другой выборке. P-value 0.4258948 - это вероятность получить такое же или более экстремальное значение статистики теста, как наблюдаемое (или более крайнее), если нулевая гипотеза верна. В контексте нашего теста, p-значение говорит о вероятности наблюдать такие же или более значительные различия в рангах между двумя группами, если на самом деле новый метод лечения не оказывает влияния на уровень болевых симптомов по сравнению с диетотерапией.

Поскольку p-значение (0.4258948) больше установленного уровня значимости (обычно α = 0.05), мы не отвергаем нулевую гипотезу. Это означает, что на основе полученных данных нет достаточных статистических доказательств для того, чтобы мы могли подтвердить наличие значимого эффекта нового метода лечения по сравнению с диетотерапией. Различия в уровне болевых симптомов между группами могут быть обусловлены лишь случайностью.

Однако, полученный результат вовсе не означает то, что новый метод лечения и диетотерапия одинаково эффективны. Это просто означает, что в данном случае у нас нет достаточных статистических оснований для утверждения обратного на основе имеющегося набора данных. Возможно, для более точных выводов могут потребоваться дополнительные исследования с большим размером выборки или с использованием других методов анализа.

# Задание 4

Проводится исследование, в котором исследуются три противоопухолевые препарата A, B плацебо (0) на трех группах мышей. В каждой из трех групп по 10 мышей. Оценивается размер опухоли у мыши. Сгенерируйте датасет следующим образом: tumor \<- tibble( therapy = c(rep("0", 10), rep("A", 10), rep("B", 10)), value = c(rep(3213, 10), rep(2687, 10), rep(2423, 10)) ) %\>% mutate(therapy = factor(therapy, levels = c("0", "A", "B"))) tumor$value <- tumor$value + rnorm(30, 0, 760) Постройте на одном графике три “ящика с усами” для наглядности. проведите дисперсионный анализ, чтобы выяснить, есть ли разница между размером опухоли во всех группах. Прокомментируйте получившийся результат. с помощью функции TukeyHSD() проведите попарные сравнения, используя критерий Тьюки. Прокомментируйте полученные результаты.

```{r task 4 set, include=TRUE}
library(tibble)
library(ggplot2)
library(dplyr)

# Генерация датасета
set.seed(123)
tumor <- tibble(
  therapy = c(rep("0", 10), rep("A", 10), rep("B", 10)),
  value = c(rep(3213, 10), rep(2687, 10), rep(2423, 10))
) %>%
  mutate(therapy = factor(therapy, levels = c("0", "A", "B")))
tumor$value <- tumor$value + rnorm(30, 0, 760)

# Построение графика "ящик с усами"
ggplot(tumor, aes(x=therapy, y=value, fill=therapy)) + 
  geom_boxplot() +
  xlab("Therapy") +
  ylab("Tumor Size") +
  ggtitle("Tumor Size by Therapy Type") +
  scale_fill_brewer(palette="Pastel1") # Используем палитру цветов для заливки

```

```{r task 4 distribution, include=TRUE}
# Проверка на нормальность распределения. Мы можем использовать тест Шапиро-Уилка для проверки нормальности распределения в каждой группе.
shapiro.test(tumor$value[tumor$therapy == "0"])
shapiro.test(tumor$value[tumor$therapy == "A"])
shapiro.test(tumor$value[tumor$therapy == "B"])
```

Результаты теста Шапиро-Уилка показывают, что p-value для всех трех групп (0, A и B) больше 0.05, что означает, что нет оснований отвергать нулевую гипотезу о нормальности распределения данных в каждой из групп. Следовательно, данные в каждой группе можно считать приблизительно нормально распределенными.

```{r}
# Проверим гомогенность дисперсий с помощью теста Бартлетта. 

# Тест Бартлетта
bartlett.test(value ~ therapy, data=tumor)
```

Результаты теста Бартлетта показывают, что p-value равно 0.9445, что значительно выше уровня значимости 0.05. Это означает, что нет оснований отвергать нулевую гипотезу о гомогенности дисперсий между группами. Следовательно, дисперсии размеров опухолей в группах терапии можно считать однородными.

Учитывая, что данные удовлетворяют обоим ключевым предположениям ANOVA (нормальность распределения и гомогенность дисперсий), использование этого метода дисперсионного анализа для сравнения средних значений размеров опухолей между группами будет корректным.

```{r task 4 variance analysis, include=TRUE}
# Дисперсионный анализ. Дисперсионный анализ (ANOVA) был выбран, потому что он позволяет сравнить средние значения трех или более групп. Это параметрический тест, который предполагает, что данные имеют нормальное распределение и гомогенность дисперсий.

anova_result <- aov(value ~ therapy, data=tumor)
summary(anova_result)

# Попарные сравнения с помощью критерия Тьюки. Критерий Тьюки для попарных сравнений был выбран после ANOVA, чтобы определить, между какими конкретными группами существуют статистически значимые различия. Этот метод контролирует общую вероятность ошибки первого рода при множественных сравнениях.

tukey_result <- TukeyHSD(anova_result)
tukey_result

```

Результаты ANOVA показывают, что есть статистически значимые различия в размере опухоли между группами терапии (p-value = 0.00539, что меньше уровня значимости 0.05). Это означает, что мы можем отвергнуть нулевую гипотезу о том, что все группы имеют одинаковые средние значения размера опухоли.

Интерпретация результатов попарных сравнений с помощью критерия Тьюки:

Сравнение A и 0: разница в средних размерах опухоли между группой A и контрольной группой "0" не является статистически значимой (p adj = 0.4185776). Сравнение B и 0: разница в средних размерах опухоли между группой B и контрольной группой "0" является статистически значимой (p adj = 0.0042031), что указывает на то, что терапия B эффективно уменьшает размер опухоли по сравнению с плацебо. Сравнение B и A: разница в средних размерах опухоли между группами B и A не достигает уровня статистической значимости (p adj = 0.0810723), но близка к нему, что может указывать на потенциальное преимущество терапии B над A.

Результаты указывают на то, что терапия B значимо уменьшает размер опухоли по сравнению с плацебо, в то время как терапия A не показала статистически значимого эффекта. Также есть намек на то, что терапия B может быть более эффективной, чем терапия A, но для окончательных выводов может потребоваться дополнительное исследование с большей выборкой или более мощным статистическим анализом.
